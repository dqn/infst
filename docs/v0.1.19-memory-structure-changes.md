# Memory Structure Changes for INFINITAS Version 2026012800

This document describes the significant memory layout changes discovered in beatmania IIDX INFINITAS version `P2D:J:B:A:2026012800`.

## Summary

The song entry structure in memory has been expanded from **1008 bytes** to **1200 bytes**, adding 192 bytes (3 additional 64-byte fields). This affects all offset calculations for reading song metadata.

## Key Changes

### Entry Size

| Version | Entry Size | Hex |
|---------|-----------|-----|
| Old (pre-2026012800) | 1008 bytes | 0x3F0 |
| **New (2026012800+)** | **1200 bytes** | **0x4B0** |

### Offset Changes

| Field | Old Offset | New Offset | Change |
|-------|-----------|-----------|--------|
| title | 0 | 0 | - |
| title_english | 64 | 64 | - |
| genre | 128 | 128 | - |
| artist | 192 | 192 | - |
| levels (10 bytes) | 288 | **480** | +192 |
| song_id | 624 | **816** | +192 |

### Memory Layout Comparison

#### Old Structure (1008 bytes)

```
Offset    Size    Field
------    ----    -----
0x000     64      title (Shift-JIS)
0x040     64      title_english (Shift-JIS)
0x080     64      genre (Shift-JIS)
0x0C0     64      artist (Shift-JIS)
0x100     88      metadata section
0x118     1       folder
0x120     10      levels[10] (difficulty levels)
0x140     8       bpm (max, min)
0x1B0     40      total_notes[10]
0x270     4       song_id
...
0x3F0     -       (entry end)
```

#### New Structure (1200 bytes)

```
Offset    Size    Field
------    ----    -----
0x000     64      title (Shift-JIS)
0x040     64      title_english (Shift-JIS)
0x080     64      genre (Shift-JIS)
0x0C0     64      artist (Shift-JIS)
0x100     192     additional fields (3 x 64 bytes, unknown purpose)
0x1C0     32      metadata section
0x1D8     1       folder (estimated)
0x1E0     10      levels[10] (difficulty levels)
0x200     8       bpm (max, min) (estimated)
0x270     40      total_notes[10] (estimated)
0x330     4       song_id
...
0x4B0     -       (entry end)
```

## Discovery Process

### Initial Symptoms

1. Tracker displayed "Song 09003" instead of the actual title "fun"
2. Level showed as 0 instead of the correct value (10 for SPA)
3. song_id was correctly read from `current_song` offset, but song info lookup failed

### Investigation Steps

1. **String Search**: Searched memory for "fun\0" string
   - Found at address `0x1431B08A0`

2. **song_id Search**: Searched for value 9003 (0x232B) as 4-byte integer
   - Found at address `0x1431B0BD0`
   - Offset from "fun" string: **816 bytes**

3. **Level Pattern Search**: Scanned for 10 consecutive bytes with values 0-12
   - Found `[0, 4, 7, 10, 0, 0, 4, 7, 10, 0]` at offset **480** from title

4. **Entry Size Validation**: Tested with 1200-byte entry size
   - Successfully found **1658 songs** (vs 80 with old 1008-byte size)
   - All song_id and level values matched correctly

### Example: "fun" Entry Analysis

```
Address 0x1431B08A0 (entry start):
  offset   0: title = "fun"
  offset  64: title_english = (empty)
  offset 128: genre = "fun"
  offset 192: artist = "FUNK SHUFFLE"
  offset 320: "Mr.T" (additional field)
  offset 480: levels = [0, 4, 7, 10, 0, 0, 4, 7, 10, 0]
  offset 816: song_id = 9003
```

## Code Changes

### `crates/reflux-core/src/game/song.rs`

```rust
impl SongInfo {
    // OLD
    // pub const MEMORY_SIZE: usize = 0x3F0;  // 1008 bytes
    // const LEVELS_OFFSET: usize = 288;
    // const SONG_ID_OFFSET: usize = 624;

    // NEW (version 2026012800+)
    pub const MEMORY_SIZE: usize = 0x4B0;     // 1200 bytes
    const LEVELS_OFFSET: usize = 480;
    const SONG_ID_OFFSET: usize = 816;
}
```

## Compatibility Notes

- This change applies to INFINITAS version `P2D:J:B:A:2026012800` and later
- Older versions may still use the 1008-byte structure
- Future versions may require additional investigation

## Additional Notes

### Lazy Loading

Songs in the new version appear to be lazy-loaded into the song_list. When scanning memory:
- Empty entries are scattered throughout the list
- Not all songs are loaded until accessed in-game
- The `fetch_song_by_id` function scans up to 5000 entries to find songs

### Offsets File

When using `--offsets-file`, the following offsets are required:

```
P2D:J:B:A:2026012800
songList = 0x1431865a0
judgeData = 0x1428380ec
playData = 0x14258b3e4
playSettings = 0x14258b144
currentSong = 0x1428382d0
```

## References

- Original C# Reflux: `.agent/Reflux/Reflux/Utils.cs` (FetchSongInfo function)
- Memory exploration tools: `cargo run --release -- explore --address <addr>`
